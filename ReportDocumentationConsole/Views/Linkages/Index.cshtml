
@model IEnumerable<ReportDocumentationConsole.ViewModels.ReportLinkage>

@{
    ViewBag.Title = "Linkages";
}
@*<h2>ChangeHistory</h2>*@
@{

    Html.RenderAction("_DropDownList", "Home", @ViewData["selectedReportName"].ToString());
}

@Html.Action("_ReportDescription", "MainConsole", new { selectedReportId = @ViewData["selectedReportId"].ToString() })

@Html.Partial("_MainButtons")

@section Scripts{
    <script src="~/Scripts/jquery-3.3.1.min.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $(".LinkageLocation").dblclick(function (e) {
                e.stopPropagation();
                var CurrentEle = $(this);
                var value = $(this).html();
                var row = $(e.target).closest('tr');
                var LinkageID = row.find($("[id*=key]")).val();
                UpdateVal(CurrentEle, value, LinkageID, "LinkageLocation");
            });
            $(".delete").click(function (e) {
                e.stopPropagation();
                var CurrentEle = $(this);
                var value = $(this).html();
                var row = $(e.target).closest('tr');
                var LinkageID = row.find($("[id*=key]")).val();
                DeleteRow(LinkageID);
            });
            //$(".rpt_name").dblclick(function (e) {
            //    e.stopPropagation();
            //    var CurrentEle = $(this);
            //    var value = $(this).html();
            //    var row = $(e.target).closest('tr');
            //    var ReportID = row.find($("[id*=key]")).val();
            //    UpdateVal(CurrentEle, value, ReportID, "rpt_name");
            //});
        });
        function UpdateVal(CurrentEle, value, LinkageID, ColumnToUpdate) {
            if ($(".cellValue") !== undefined) {
                if ($(".cellValue").val() !== undefined) {
                    $(".cellValue").parent().html($("#OriginalValue").val().trim());
                    $(".cellValue").remove();
                }
            }
            if (value.match("<") == null) {
                $(CurrentEle).html('<div class="cellValue" id="cellWrapper"> ' +
                    '<input class="cellValue" type="text" id="txtValue" value="' + value + '" />' +
                    '<input class="cellValue" type="hidden" value="' + LinkageID + '" id="keySelected" />' +
                    '<input class="cellValue" type="hidden" value="' + ColumnToUpdate + '" id="ColumnToUpdate" /> ' +
                    '<input class="cellValue" type="hidden" value="' + value + '" id="OriginalValue" /> ' +
                    '<input class="cellValue" type="button" value="save"   onclick="return SaveChanges()" /> ' +
                    '<input class="cellValue" type="button" value="cancel" onclick="return CancelChanges()" /> ' +
                    '</div> ');
            }
            $(".cellValue").focus();
            $(".cellValue").keyup(function (event) {
                if (event.keyCode == 13) {
                    $(CurrentEle).html($(".cellValue").val().trim());
                }
            });
        }

        function CancelChanges(e) {
            if ($(".cellValue") !== undefined) {
                if ($(".cellValue").val() !== undefined) {
                    $(".cellValue").parent().html($("#OriginalValue").val().trim());
                    $(".cellValue").remove();
                }
            }
            window.location.reload();
        }

        function DeleteRow(LinkageID) {
            var link = {};

            link.ID = LinkageID;
            $.ajax({
                type: "POST",
                url: "Linkages/DeleteLK",
                data: '{link: ' + JSON.stringify(link) + '}',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    alert("done!!Hit Linkage button to reload");
                    //location.href = location.href;
                    window.location.reload();
                }

            });
        }

        function SaveChanges(e) {
            var linkage = {};
            linkage.ColumnToUpdate = $("[id*=ColumnToUpdate]").val();
            linkage.FieldValue = $("[id*=txtValue]").val();
            linkage.ID = $("[id*=keySelected]").val();
            $.ajax({
                type: "POST",
                url: "Linkages/SaveLinkage",
                data: '{linkage: ' + JSON.stringify(linkage) + '}',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    alert("done!!");
                    location.href = location.href ;
                    window.location.reload();
                }

            });
        }
    </script>
}



<div style="height: 500px; overflow: auto;">
    <table class="table table-hover">
        <thead>
            <tr>
                @*<th scope="col">ID</th>*@
                <th></th>
                <th scope="col">LinkageType</th>
                @*<th scope="col">LinkageLocation</th>*@
                <th>@Html.DisplayNameFor(model => model.LinkageLocation)</th>
                <th scope="col">RowCreateDate</th>
                <th scope="col">CreateEnduserName</th>
                <th></th>

            </tr>
        </thead>
        <tbody>
            @foreach (var sp in Model)
            {
                <tr class="table-primary">
                    @*<th scope="row">Primary</th>*@
                    @*<td>@sp.ID</td>*@
                    <td>@Html.HiddenFor(modelItem => sp.ID, new { id = "key" })</td>
                    
                    <td>@sp.LinkageType</td>
                    @*<td>@sp.LinkageLocation</td>*@
                    <td><div class="LinkageLocation">@Html.DisplayFor(modelItem => sp.LinkageLocation)</div></td>

                    <td>@sp.RowCreateDate.ToShortDateString()</td>
                    <td>@sp.CreateEndUserName</td>
                    <td width="40px"><div class="delete"><button class="btn btn-outline-secondary">Delete</button></div></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@*@using (Html.BeginForm("AddLinkages", "Linkages", FormMethod.Post))

    {
        @Html.Hidden("selectedReportId", @ViewData["selectedReportId"])
        @Html.Hidden("selectedReportName", @ViewData["selectedReportName"])
        <input type="submit" value="ADD" class="btn btn-primary" />
    }*@
@Html.Partial("_AddLinkages")

@*<input type="button" class="btn btn-primary btn-lg btn-block" value="ADD" onclick="location.href='@Url.Action("AddChangeHistory", "MainConsole")'" />*@
